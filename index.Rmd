---
title: "Evaluación Experimental"
subtitle: "Una aplicación del Proyecto Esperanza en Oaxaca"
author: |
  | Irvin Rojas
institute: "CIDE"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: [default, default-fonts, "https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap-grid.min.css", "https://use.fontawesome.com/releases/v5.7.2/css/all.css", "https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css"]
    seal: false
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

class: title-slide, inverse, center, middle

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = F,
                      message = F,
                      fig.path = "figures/")

library(tidyverse)
library(sandwich)
library(estimatr) # regresión con errores robustos y agrupados
library(modelsummary) # para hacer tablas
library(ri2) # inferencia por aleatorización


xfun::pkg_load2(c('base64enc', 'htmltools', 'mime'))
```

```{css, echo = FALSE}
.huge .remark-code { /*Change made here*/
  font-size: 200% !important;
}
.tiny .remark-code { /*Change made here*/
  font-size: 60% !important;
}
```

.title[
# Evaluación Experimental
]
.subtitle[
### Una aplicación del Proyecto Esperanza en Oaxaca
]
<br/>

.author[
### Irvin Rojas <br> [rojasirvin.com](https://www.rojasirvin.com/) <br> [<i class="fab fa-github"></i>](https://github.com/rojasirvin) [<i class="fab fa-twitter"></i>](https://twitter.com/RojasIrvin) [<i class="ai ai-google-scholar"></i>](https://scholar.google.com/citations?user=FUwdSTMAAAAJ&hl=en)
]

<br/>

.affiliation[
### Centro de Investigación y Docencia Económicas <br> División de Economía  <br>  <br> Actualización: `r Sys.Date()`
]

---

# Paquetes que usaremos

- *tidyverse*: manejo de datos
- *haven*: leer datos de múltiples formatos
- *sandwich*: estimación de errores robustos y agrupados
- *modelsummary*: presentar resultados en tablas
- *ri2*: realizar inferencia por aleatorización

---
# Descripción de variables

```{r echo=T}
data <- haven::read_dta("data/analysis_dataset.dta")
```

---
# Descripción de variables

Consideremos la variable **age**, que indica la educación de la socia en años

Usando los datos de la línea base sabemos que la edad promedio de las socias es de 7.62 años

```{r echo=T}
bl <- data %>% 
  filter(t==0)

summary(bl$educ)
```
---

# El balance

Para estimar de forma consistente el efecto del tratamiento debe suceder que la asignación al tratamiento sea independiente de las características de las socias en la línea base

Veamos la media de la edad de quienes recibieron y no recibieron el tratamiento

```{r echo=T}
#Por grupos
bl %>% 
  group_by(hopegroup) %>%
  summarize(mean=mean(educ,na.rm=T)) %>% 
  ungroup()
```

---

# El balance

Hacemos una prueba de diferencia de medias

Planteamos una hipótesis nula $H0: educ_{tratadas}=educ_{no tratadas}$

Construimos un estadístico $t$ y formulamos una regla de decisión

Si $p<\alpha=0.05$ rechazamos la $H_0$

```{r echo=T}
t.test(educ ~ hopegroup,
       data = bl)
```


---

# El balance

Podemos hacer uso de una regresión lineal para hacer exactamente lo mismo

$$educ_i=\gamma_0 + \gamma_1 tratamiento_i + e_i$$

```{r echo=T}
summary(m1 <- lm(educ ~ hopegroup,
   data = bl))$coef
```

---

# El balance

Sin embargo, la prueba realizada anteriormente asume que los errores son independientes e idénticamente distribuidos (iid)

En otras palabras, que los individuos en nuestra muestra reciben choques aleatorios que no están correlacionados

Esto no sucede en nuestro caso: tenemos socias que son parte de grupos de crédito y ahorro y que, por tanto, reciben choques que están correlacionados (mercado laboral, clima, programas)

Debemos tomar en cuenta que estos errores no son independientes para estimar correctamente la matriz de varianzas de $\hat{\beta}$

---

# El balance

La función *lm_robust* funciona como *lm* pero podemos especificar errores agrupados

```{r echo=T}
summary(m1r <- lm_robust(educ ~ hopegroup,
                         clusters = communitybank,
                         se_type = "CR0",
                         data = bl))$coef
```
---

# El balance

En una evaluación, tenemos que verificar el supuesto de independencia al mostrar evidencia de que las características de los individuos **antes** de la intervención no difieren entre tratados y no tratados

Estimo una regresión para cada características usando la especificación que usé antes para la educación

Guardo los resultados en una lista llamada *models*

```{r echo=T}
#Para el resto de los covariables
models <- list()

models[['Edad']] <- lm_robust(age ~ hopegroup,
                                   clusters = communitybank,
                                   se_type = "CR0",
                                   data = bl)

models[['Educación']] <- lm_robust(educ ~ hopegroup,
                         clusters = communitybank,
                         se_type = "CR0",
                         data = bl)
```

```{r}
models[['Prop. evangélica']] <- lm_robust(evangelical ~ hopegroup,
                         clusters = communitybank,
                         se_type = "CR0",
                         data = bl)
models[['Hijos']] <- lm_robust(children ~ hopegroup,
                         clusters = communitybank,
                         se_type = "CR0",
                         data = bl)
models[['Líder']] <- lm_robust(bankleader ~ hopegroup,
                         clusters = communitybank,
                         se_type = "CR0",
                         data = bl)
```

---

# El balance

Puedo presentar los resultados de estimar la misma especificación para varias características usando *modelsummary*

```{r echo=T, eval=F}
modelsummary::modelsummary(models,
                           statistic = "std.error",
                           coef_map = c('hopegroup' = "Hope Group"),
                           coef_omit = "Intercept",
                           gof_omit = 'DF|Deviance|R2|AIC|BIC',
                           stars=c('*' = .1, '**' = .05, '***'=0.01),
                           title = "Balance de X en línea base")

```
---

# El balance

```{r echo=F}
modelsummary::modelsummary(models,
                           statistic = "std.error",
                           coef_map = c('hopegroup' = "Hope Group"),
                           coef_omit = "Intercept",
                           gof_omit = 'DF|Deviance|R2|AIC|BIC',
                           stars=c('*' = .1, '**' = .05, '***'=0.01),
                           title = "Balance de X en línea base")

```

---

# El efecto del tratamiento

Si el supuesto de independencia se cumple, el efecto del tratamiento en una variable $y$ puede ser identificado simplmente al comparar $y$ para tratados y no tratados **después de la intervención**

Sabemos que podemos hacer esto con una regresión como sigue

$$y_i=\beta_0+\beta_1 tratamiento + \varepsilon_i$$

donde $\hat{\beta_1}$ es el efecto del tratamiento

Estimemos el efecto de haber sido asignado a la intervención del Proyecto Esperanza sobre un índice de agencia, **StdAnderAgencyIndex** usando los datos recabados un año después del tratamiento

---

# El efecto del tratamiento

Primero estimemos una regresión con errores robustos (ignorando errores agrupados)

```{r echo=T}
summary(e0a <- lm_robust(StdAnderAgencyIndex ~ hopegroup,
                        se_type = "HC1",
                        data = filter(data, t==2)))$coef[,c(1:2,4)]
```

El tratamiento tiene un efecto positivo de 0.14 $\sigma$ en el índice de agencia

Este efecto es estadísticamente significativo (0.054)

---

# El efecto del tratamiento

Notemos qué pasa cuando agregamos un vector de *controles*

Es común en evaluación estimar una *regresión larga*

$$y_i=\beta_0+\beta_1 tratamiento + BX_i +  \varepsilon_i$$

donde $X_i$ representa un vector de características que explican $y_i$, pero que no fueron afectadas por el tratamiento

```{r echo=T}
summary(e0b <- lm_robust(StdAnderAgencyIndex ~ hopegroup + age + educ + evangelical + children + children_under_18 + bankleader + Dwelling_Index,
                        se_type = "HC1",
                        data = filter(data, t==2)))$coef[,c(1:2,4)]
```
---

# El efecto del tratamiento

Primero hagamos más corto lo que tenemos que escribir

```{r echo=T}
X <- c("hopegroup", "age", "educ", "evangelical", "children", "children_under_18", "bankleader", "Dwelling_Index")

reglarga <- as.formula(paste("StdAnderAgencyIndex ~ ",
                             paste(X, collapse= "+")))

reglarga
```
---

# El efecto del tratamiento

Podemos sustituir *reglarga* en la parte donde va la especificación de la regresión

```{r echo=T}
summary(e1 <- lm_robust(reglarga,
                        clusters = communitybank,
                        se_type = "CR0",
                        data = filter(data, t==2)))$coef[,c(1:2,4)]

```
---

# El efecto del tratamiento

Recordemos que la aleatorización ocurrió por parejas,
entonces debemos incluir efectos fijos por parejas para comparar entre socias de grupos comparables


```{r echo=T}
summary(e2 <- lm_robust(reglarga,
                        fixed_effects = pair_number,
                        clusters = communitybank,
                        se_type = "CR0",
                        data = filter(data, t==2)))$coef[,c(1:2,4)]
```

---

# El efecto del tratamiento

Comparamos las estimaciones que hemos hecho hasta ahora

```{r echo=T, eval=F}
modelsummary::modelsummary(list('Errores Robustos'=e0a,
                                'Errores Robustos + X'=e0b,
                                'Errores agrupados + X'=e1,
                                'Errores agrupados + X + parejas'=e2),
                           statistic = "std.error",
                           coef_map = c('hopegroup' = "Hope Group"),
                           coef_omit = "Intercept",
                           gof_omit = 'DF|Deviance|R2|AIC|BIC',
                           stars=c('*' = .1, '**' = .05, '***'=0.01),
                           title = "Efectos de tratamiento en el índice de agencia 12 meses después de la intervención")
```

---

# El efecto del tratamiento

```{r echo=F}
modelsummary::modelsummary(list('Errores Robustos'=e0a,
                                'Errores Robustos + X'=e0b,
                                'Errores agrupados + X'=e1,
                                'Errores agrupados + X + parejas'=e2),
                           statistic = "std.error",
                           coef_map = c('hopegroup' = "Hope Group"),
                           coef_omit = "Intercept",
                           gof_omit = 'DF|Deviance|R2|AIC|BIC',
                           stars=c('*' = .1, '**' = .05, '***'=0.01),
                           title = "Efectos de tratamiento en el índice de agencia 12 meses después de la intervención")
```

---

# ANCOVA

Introducimos el valor en la línea base del índice de agencia y un indicador de si dicho valor no fue colectado en la línea base

```{r echo=T, eval=T, results=F}
X <- c("hopegroup", "age", "educ", "evangelical", "children", "children_under_18", "bankleader", "Dwelling_Index", "Baseline_StdAnderAgencyIndex", "M_Baseline_StdAnderAgencyIndex")

reglarga <- as.formula(paste("StdAnderAgencyIndex ~ ",
                             paste(X, collapse= "+")))

summary(e3 <- lm_robust(reglarga,
                        fixed_effects = pair_number,
                        clusters = communitybank,
                        se_type = "CR0",
                        data = filter(data, t==2)))$coef[,c(1:2,4)]

```

---

# El efecto del tratamiento

```{r echo=F}
modelsummary::modelsummary(list('Errores Robustos'=e0a,
                                'Errores Robustos + X'=e0b,
                                'Errores agrupados + X'=e1,
                                'Errores agrupados + X + parejas'=e2,
                                '+ ANCOVA'=e3),
                           statistic = "std.error",
                           coef_map = c('hopegroup' = "Hope Group"),
                           coef_omit = "Intercept",
                           gof_omit = 'DF|Deviance|R2|AIC|BIC',
                           stars=c('*' = .1, '**' = .05, '***'=0.01),
                           title = "Efectos de tratamiento en el índice de agencia 12 meses después de la intervención")
```

---

# Inferencia por aleatorización

Declaramos la estructura del experimento

- Clusters: bancos
- Bloques: parejas

Usamos los datos del seguimiento de un año

.pull-left[

```{r echo=T}
df <- filter(data, t==2)

declaration <- 
  with(df,{
    declare_ra(
      blocks = pair_number, # bloques = parejas
      clusters = id_g, # clusters o grupos = bancos
      )
  })
```
]

.pull-right[
```{r echo=T}
declaration
```
]
---

# Inferencia por aleatorización

.pull-left[
```{r echo=T, cache=T}
ri <- conduct_ri(
  StdAnderAgencyIndex ~ hopegroup,
  assignment = "hopegroup",
  sharp_hypothesis = 0,
  declaration = declaration,
  data = df,
  sims = 1000
)
```
]

.pull-rigth[
```{r echo=T}
summary(ri)
```
]

---

# Inferencia por aleatorización

Agregamos controles

.pull-left[
```{r echo=T, cache=T}
ri <- conduct_ri(
  StdAnderAgencyIndex ~ hopegroup +
  age + educ + evangelical + children + children_under_18 + bankleader + Dwelling_Index +
  factor(pair_number) +
  Baseline_StdAnderAgencyIndex +
  M_Baseline_StdAnderAgencyIndex,
  assignment = "hopegroup",
  sharp_hypothesis = 0,
  declaration = declaration,
  data = df,
  sims = 1000
)
```
]

.pull-rigth[
```{r echo=T}
summary(ri)
```
]


---

class: center, middle, inverse

# ¡Gracias!

.author[
### [rojasirvin.com](https://www.rojasirvin.com/) <br> [<i class="fab fa-github"></i>](https://github.com/rojasirvin) [<i class="fab fa-twitter"></i>](https://twitter.com/RojasIrvin) [<i class="ai ai-google-scholar"></i>](https://scholar.google.com/citations?user=FUwdSTMAAAAJ&hl=en)
]

<br/>


(Esta presentación está basada en el artículo [*Les hizo justicia la revolución*](http://rioarriba.mx/articulo.php?iden=les-hizo-justicia-la-revolucion).)

<br/>

<br/>


Presentación creada usando el paquete [**xaringan**](https://github.com/yihui/xaringan) en R.

El chakra viene de [remark.js](https://remarkjs.com), [**knitr**](https://yihui.org/knitr/), y [R Markdown](https://rmarkdown.rstudio.com).
